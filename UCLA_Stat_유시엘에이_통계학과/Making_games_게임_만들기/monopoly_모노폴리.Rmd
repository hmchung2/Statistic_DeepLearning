---
title: "102A Homework 4 - Monopoly"
author: "Daniel Chung"
date: "2/19/19"
output:
  pdf_document: default
  html_document: default
---


```{r, error = TRUE}
gameboard <- data.frame(space = 1:40, title = c("Go" , "Mediterranean Avenue" , "Community Chest" , "Baltic Avenue" , "Income Tax" , "Reading Railroad" , "Oriental Avenue" , "Chance" , "Vermont Avenue" , "Connecticut Avenue" , "Jail" , "St. Charles Place" , "Electric Company" , "States Avenue" , "Virginia Avenue" , "Pennsylvania Railroad" , "St. James Place" , "Community Chest" , "Tennessee Avenue" , "New York Avenue" , "Free Parking" , "Kentucky Avenue" , "Chance" , "Indiana Avenue" , "Illinois Avenue" , "B & O Railroad" , "Atlantic Avenue" , "Ventnor Avenue" , "Water Works" , "Marvin Gardens" , "Go to jail" , "Pacific Avenue" , "North Carolina Avenue" , "Community Chest" , "Pennsylvania Avenue" , "Short Line Railroad" , "Chance" , "Park Place" , "Luxury Tax" , "Boardwalk"), stringsAsFactors = FALSE)
chancedeck <- data.frame(index = 1:15, card = c("Advance to Go" , "Advance to Illinois Ave." , "Advance to St. Charles Place" , "Advance token to nearest Utility" , "Advance token to the nearest Railroad" , "Take a ride on the Reading Railroad" , "Take a walk on the Boardwalk" , "Go to Jail" , "Go Back 3 Spaces" , "Bank pays you dividend of $50" , "Get out of Jail Free" , "Make general repairs on all your property" , "Pay poor tax of $15" , "You have been elected Chairman of the Board" , "Your building loan matures"), stringsAsFactors = FALSE)
communitydeck <- data.frame(index = 1:16, card = c("Advance to Go" , "Go to Jail" , "Bank error in your favor. Collect $200" , "Doctor's fees Pay $50" , "From sale of stock you get $45" , "Get Out of Jail Free" , "Grand Opera Night Opening" , "Xmas Fund matures" , "Income tax refund" , "Life insurance matures. Collect $100" , "Pay hospital fees of $100" , "Pay school tax of $150" , "Receive for services $25" , "You are assessed for street repairs" , "You have won second prize in a beauty contest" , "You inherit $100"), stringsAsFactors = FALSE)


### To get you started, here is a simple function to roll two dice.

# Dice --------------------------------------------------------------------

random_dice <- function(verbose=FALSE){
  faces <- sample(1:6, 2, replace=TRUE)
  if(faces[1] == faces[2]){
    doubles = TRUE} else {
      doubles = FALSE}
  movement = sum(faces)
  if(verbose) cat("Rolled:", faces[1], faces[2], "\n")
  
  return(list(faces=faces, doubles=doubles, movement=movement))
}


# Manual Dice -------------------------------------------------------------

# this Reference Class allows you to create a set of manual dice

manual_dice = setRefClass("manual_dice", 
                   fields = list(
                     rolls = "numeric",
                     pos = "numeric",
                     verbose = "logical",
                    double_count = "numeric"
                     ), 
                   methods = list(
                     roll = function() {
                       faces = rolls[pos + seq_len(2)]
                       pos <<- pos + 2
                       if(faces[1] == faces[2]) {
                         doubles = TRUE
                         }
                       else doubles = FALSE
                       movement = sum(faces)
                       if(verbose) cat("Rolled:", faces[1], faces[2], "\n")
                       
                       return(list(faces=faces, doubles=doubles, movement=movement))
                     }
                   )
)


preset_rolls <- manual_dice$new(rolls = c(6,4, 5,3, 3,5, 6,2, 5,4, 4,1, 2,6, 4,4, 4,4, 2,2, 
           4,3, 4,4, 1,4, 3,4, 1,2, 3,6, 5,4, 5,5, 1,2, 5,4, 3,3, 1,1, 2,1, 1,3),
           pos = 0, verbose = TRUE)

preset_dice <- function() preset_rolls$roll()


# Player Reference Class --------------------------------------------------

player <<- setRefClass("player", 
                      fields = list(
                        pos = "numeric",        
                        verbose = "logical",
                        jail_landing = "numeric",  
                        jail = "logical",      
                        vec = "numeric",
                        numb_rolls = "numeric",
                        double_count = "numeric"
                        ), 
                      methods = list(
                        turnjail = function(){  
                          jail_landing <<- jail_landing + 1  
                        },
                        isjail = function() {   
                          jail <<- TRUE 
                      
                          },
                        
                       
                        doubles = function(player, tracking) {   
                          double_count <<- 0  
                          while (double_count <= 3) {
                           double_count <<- double_count + 1
                           
                           if (roll$doubles == FALSE) {
                               move_fwd(roll$movement)
                              tracking$increase_count(pos)
        
                              break
                            }
                            if (double_count < 3) {
                               
                               tracking$increase_count(pos)
                            if(roll$doubles == TRUE){
                              ############################################## number of double rolls################################
                              #Double count statement shows up late here. I was able to make it appear at the top of outputs by making
                              #new object in the field of manual dice, but then it starts to create other minor problems....##########
                              if(verbose) cat("Double Count is now:",double_count,"\n")          
                            }
                              
                              if(verbose) cat("rolled doubles, take another turn\n")
                          
                            jail <<- FALSE
                            
                          } else {         
                            if (double_count == 3) {
                              go_2_space_n(11, verbose = FALSE)
                              if (verbose) cat("Double count is now: 3\n")
                              if (verbose) cat("Going to jail","\n")
                              go_to_jail(player, tracking)
                              jail <<- TRUE
                              turnjail()
                              break
                            }
                          }
                           
                           roll <- dice()
                           if (double_count + 1 == 3) {
                             next
                           }
                             move_fwd(roll$movement)
                            if (roll$doubles == FALSE) {
                              tracking$increase_count(pos)
         
                              break
                            }
                          } 
                          
                        },
    
         move_fwd = function(n) {
           if(verbose) cat(paste("Player at:", pos, ",", gameboard$title[pos], "."))
           if(verbose) cat(" Player moves:", n, "\n")
           pos <<- pos + n
           if (pos == 31) {
             if(verbose) cat("Player now at: 31, Go to Jail","\n")
             if(verbose) cat("Going to jail","\n")
             jail <<- TRUE
             pos <<- 11
           }
           if(pos == 8){
             if(verbose) cat("Player now at: 8, Chance",".", "\n" )
             if(verbose) cat("Tally at 8: Chance","\n")
           }
           if(pos > 40) pos <<- pos - 40
           if(jail == FALSE & pos != 8){
             if(verbose) cat(paste("Player now at:", pos, ",", gameboard$title[pos], ".\n"))
           }
         
           },
                          go_2_space_n = function(n, verbose = FALSE){ 
                          if(verbose) cat("Player at:", pos, ".\n")
                          pos <<- n
                          if (pos == 31) {
                            pos <<- 11
                          }
                          
                             if(verbose) cat("Player now at:", pos, ".\n") 
                          
                         
                        },
                        go_to_jail = function(player, tracking) {
                          jail <<- TRUE
                          ###going to jail
                          pos <<- 11
                          tracking$increase_count(11)
                        },
                        a_jail = function(player, tracking){ 
                          turnjail()
                          while (jail == TRUE){
                           
                            roll_at_jail<-dice() 
                            if(roll_at_jail$doubles == FALSE & jail_landing != 3){
                              if(verbose) cat("staying in jail","\n")
                            }
                            
                            if (jail_landing == 3 & roll_at_jail$doubles == FALSE){
                              jail <<- FALSE
                              if(verbose) cat("third turn in jail","\n")
                              if(verbose) cat("getting out of jail","\n")
                              move_fwd(roll_at_jail$movement)
                              tracking$increase_count(pos)
                              
                                jail_landing <<-0
                               
                                break
                            } else {
                              if (roll_at_jail$doubles == TRUE){
                              jail <<- FALSE
                              if(verbose) cat("Jail: rolled doubles\n")
                              if(verbose) cat("getting out of jail\n")
                              move_fwd(roll_at_jail$movement)
                              tracking$increase_count(pos)
         
                              
                              jail_landing <<- 0
                              
                              break
                              } 
                            }
                            go_to_jail(player, tracking)
                            break
                          }
                          if (pos == 31){ 
                            isjail()
                            a_jail(player, tracking)
                          }
                        },
                        
                         record_pos = function(square) {    
                           vec <<- c(vec, square)             
                         }
                      )
)





# Space Tracking Reference Class ------------------------------------------

tracking <- setRefClass("tracking",
                        fields = list(
                          tally = "numeric",
                          verbose = "logical"
                        ),
                        methods = list(
                          increase_count = function(n){
                            tally[n] <<- tally[n] + 1
                            if(verbose) cat("Tally at ",n,": ", gameboard$title[n],"\n",sep="")
                          }
                        )
)

# Taking a turn -----------------------------------------------------------



taketurn <- function(player, tracking) {
      
          
    if (player$jail == TRUE) {
       player$a_jail(player, tracking)
      }
      else {
        if (player$jail == FALSE) {
          roll <<- dice()
          player$move_fwd(roll$movement) 
          if(roll$doubles == FALSE & (player$pos != 3 & player$pos != 18 & player$pos != 34 & player$pos != 8 & player$pos != 23 & player$pos != 37)) {
             tracking$increase_count(player$pos)
         
          }
          if(player$pos == 3 | player$pos == 18 | player$pos == 34) {
            sample_comp <- sample(1:16, 1, replace = TRUE)
            if (sample_comp %in% 3:16) {
                 tracking$increase_count(player$pos)
             }
            if(player$verbose) cat("Drew Community Chest Card", sample_comp, "\n")
            if (sample_comp == 1) {
              player$go_2_space_n(1)
              tracking$increase_count(player$pos)
              if(player$verbose) cat("Community Chest Card", sample_comp, levels(communitydeck$card)[[1]])
              }
            if (sample_comp == 2) {
              jail <<- TRUE
               player$isjail()
              if(player$verbose) cat("Community Chest Card", sample_comp, levels(communitydeck$card)[[6]])
               player$go_to_jail(player, tracking)
              
            }
            if (sample_comp %in% 3:16) {
        
              
            }
          }
           if (player$pos == 8 | player$pos == 23 | player$pos == 37) {
             sample_chance <- sample(1:15, 1, replace = TRUE)
             if (sample_chance %in% 10:15) {
                 tracking$increase_count(player$pos)
             }
             if(player$verbose) cat("Drew Chance Card\n")
             if (sample_chance == 1) {
               player$go_2_space_n(1) 
              tracking$increase_count(player$pos)
               }
             if (sample_chance == 2) {
               player$go_2_space_n(25)  
               tracking$increase_count(player$pos)
               }
             if (sample_chance == 3) {
               player$go_2_space_n(12)  
                tracking$increase_count(player$pos)
             }
             if (sample_chance == 4) {
               if (player$pos %in% 13:28) {
                 player$go_2_space_n(29)  
                 tracking$increase_count(player$pos)
               } else {
                 player$go_2_space_n(13)  
                 tracking$increase_count(player$pos)
               }
             }
             if (sample_chance == 5) {
               if (player$pos == 8)  {
                 player$go_2_space_n(16) 
                 tracking$increase_count(player$pos)
               }
               else if (player$pos == 23) {
                 player$go_2_space_n(26) 
                tracking$increase_count(player$pos)
               }
               else {
                 player$go_2_space_n(6)  
                  tracking$increase_count(player$pos)
               }
             }
             if (sample_chance == 6) {
               player$go_2_space_n(6)  
               tracking$increase_count(player$pos)
             }
             if (sample_chance == 7) {
               player$go_2_space_n(40)  
               tracking$increase_count(player$pos)
             }
             if (sample_chance == 8) {
               if(player$verbose) cat("Chance Card", sample_chance, chancedeck$card[8], "\n")
               if(player$verbose) cat("Going to Jail", "\n")
               player$go_to_jail(player, tracking)
             jail <<- TRUE
               }
            if (sample_chance == 9) {
               player$pos == 8 | player$pos == 23 | player$pos == 37
               if (player$pos == 8 ) {
                 player$go_2_space_n(5) 
                 tracking$increase_count(player$pos)
               }
               if (player$pos == 23 ) {
                 player$go_2_space_n(20) 
                 tracking$increase_count(player$pos)
               }
               if (player$pos == 37 ) {
                 player$go_2_space_n(34) 
                 sample_comp <- sample(1:16, 1, replace = TRUE)
            if (sample_comp %in% 3:16) {
                 tracking$increase_count(player$pos)
             }
            if (sample_comp == 1) {
              player$go_2_space_n(1)
              tracking$increase_count(player$pos)
              }
            if (sample_comp == 2) {
              jail <<- TRUE
               player$isjail()
               player$go_to_jail(player, tracking)
            }
            if (sample_comp %in% 3:16) {
            }
               }
             }
           }
                    if (player$pos == 31) {
            player$go_to_jail(player, tracking)
            player$a_jail(player, tracking) 
          }
          if (roll$doubles == TRUE & player$jail == FALSE) {
            player$doubles(player, tracking)
          }
        }
      }
}
          


# Part 1: 20 turns of the Manual Dice -----------------------------------------------

dice <- function() preset_dice()  # we alias preset_dice to dice()
# by renaming dice(), we can use the same take_turn function we created and use a
# different method for generating dice rolls

set.seed(10)
space_tracking <- tracking$new(tally = rep(0,40), verbose = TRUE)  
player1 <- player$new(pos = 1, verbose = TRUE, double_count = numeric(0), jail_landing = 0, jail = FALSE)
for(i in 1:19){ # 100 turns for each game
  cat("\n## Turn", i,"\n")
  taketurn(player1, space_tracking)
}



# Part 2: Running a simulation of 1000 games -----------------------------------------

set.seed(1)

dice <- function() random_dice(verbose = FALSE)  # we alias random_dice(verbose = FALSE) to dice()

space_tracking <- tracking$new(tally = rep(0,40), verbose = FALSE)   # new blank tracking object

start_time <- Sys.time()

for(i in 1:1000){ # simulate 1000 games
  if(i %% 100 == 0) cat("#### NEW GAME",i,"##### \n")
  player1 <- player$new(pos = 1, verbose = FALSE, double_count = numeric(0), jail_landing = 0, jail = FALSE)  # new players for each game
  player2 <- player$new(pos = 1, verbose = FALSE, double_count = numeric(0), jail_landing = 0, jail = FALSE)
  for(i in 1:150){ # 150 turns for each game
    if(player1$verbose) cat("Player 1 turn\n")
    taketurn(player1, space_tracking)  
    if(player2$verbose) cat("Player 2 turn\n")
    taketurn(player2, space_tracking)  
  }
}

end_time <- Sys.time()

# the results after 1000 turns. No rules have been implemented yet. Takes about 34 seconds on my computer
# after implementing all the rules, it takes about 1 min 40 seconds to run
time_dif = end_time - start_time  
cat('Simulation time: ', time_dif)

results <- cbind(gameboard, tally = space_tracking$tally)
results <- cbind(results, rel = results$tally/sum(results$tally))
results_arranged <- results[order(results$tally, decreasing = TRUE), ]
print(results_arranged)
print(results)  # pretty uniform
sum(results$tally)
barplot(results$tally, names.arg = results$title, horiz = FALSE, las = 2)

```
